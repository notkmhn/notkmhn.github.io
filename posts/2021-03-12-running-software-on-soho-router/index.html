<!doctype html><html lang=en data-mode=dark><head prefix="og: http://ogp.me/ns#"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.85.0"><meta name=theme content="Color Your World -- gitlab.com/rmaguiar/hugo-theme-color-your-world"><title>Running your own services on your SOHO router for the greater good | rb9</title><meta name=author content="kmhn"><meta name=description content="Recently, I've been wanting to run a PiHole server for ad-blocking in my home network, but I didn't want to set up a machine exclusively for it..."><meta name=robots content="index follow"><meta name=referrer content="no-referrer-when-downgrade"><link rel=canonical href=https://rb9.nl/posts/2021-03-12-running-software-on-soho-router/><link rel=icon type=image/png href=/favicon.png><script src=/js/jquery-3.5.2.min.js integrity=sha384-1bBkQsBsW57bhUxHyzsKVpryuEaU5QMhTAMnrtXtwU0bfGso+sR3Us0iRBVE+BVo></script><meta property="og:site_name" content="rb9"><meta property="og:title" content="Running your own services on your SOHO router for the greater good"><meta property="og:description" content="Recently, I've been wanting to run a PiHole server for ad-blocking in my home network, but I didn't want to set up a machine exclusively for it..."><meta property="og:url" content="https://rb9.nl/posts/2021-03-12-running-software-on-soho-router/"><meta property="og:image" content="https://rb9.nl/cover_hu34ef8a6c2ad2188b0efd6a4dc392a36b_24932_1200x630_fill_box_smart1_2.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="630"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://rb9.nl/cover_hu34ef8a6c2ad2188b0efd6a4dc392a36b_24932_1280x640_fill_box_smart1_2.png"><meta property="og:type" content="article"><meta property="article:published_time" content="2021-03-12"><meta property="article:modified_time" content="2021-03-20"><meta property="og:updated_time" content="2021-03-20"><meta property="article:author" content="kmhn"><meta name=twitter:creator content="@kmhnassar"><meta name=twitter:site content="@kmhnassar"><meta name=twitter:dnt content="on"><meta name=theme-color content="#222"><meta name=apple-mobile-web-app-capable content="yes"><meta name=apple-mobile-web-app-status-bar-style content="default"><script type=application/ld+json>{"@context":"https://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebSite","@id":"https:\/\/rb9.nl\/"},"headline":"Running your own services on your SOHO router for the greater good","description":"Recently, I've been wanting to run a PiHole server for ad-blocking in my home network, but I didn't want to set up a machine exclusively for it...","image":["https://rb9.nl/cover_hu34ef8a6c2ad2188b0efd6a4dc392a36b_24932_1280x640_fill_box_smart1_2.png","https://rb9.nl/cover_hu34ef8a6c2ad2188b0efd6a4dc392a36b_24932_1200x630_fill_box_smart1_2.png","https://rb9.nl/cover_hu34ef8a6c2ad2188b0efd6a4dc392a36b_24932_1280x0_resize_box_2.png"],"url":"https:\/\/rb9.nl\/posts\/2021-03-12-running-software-on-soho-router\/","inLanguage":"en","datePublished":"2021-03-12","dateModified":"2021-03-20","wordCount":"3030","publisher":{"@type":"Person","name":"kmhn"},"author":{"@type":"Person","name":"kmhn","description":"Enjoys computer science, mathematics and information security.","sameAs":["https://github.com/khalednassar","https://keybase.io/kmhn","https://twitter.com/kmhnassar"]}}</script><link rel=stylesheet href=/css/main.min.css><noscript><meta name=theme-color content="#f27466"><style>html{--accent:#f27466}.req-js{display:none}</style></noscript><link rel=preload href=/fonts/open-sans-v17-latin-700.woff as=font crossorigin=anonymous><link rel=preload href=/fonts/open-sans-v17-latin-700.woff2 as=font crossorigin=anonymous><link rel=preload href=/fonts/open-sans-v17-latin-italic.woff as=font crossorigin=anonymous><link rel=preload href=/fonts/open-sans-v17-latin-italic.woff2 as=font crossorigin=anonymous><link rel=preload href=/fonts/open-sans-v17-latin-regular.woff as=font crossorigin=anonymous><link rel=preload href=/fonts/open-sans-v17-latin-regular.woff2 as=font crossorigin=anonymous><link rel=preload href=/fonts/oswald-v29-latin-700.woff as=font crossorigin=anonymous><link rel=preload href=/fonts/oswald-v29-latin-700.woff2 as=font crossorigin=anonymous><link rel=me href=https://github.com/khalednassar><link rel=me href=https://keybase.io/kmhn><link rel=me href=https://twitter.com/kmhnassar><script>'use strict';const ROOT=document.documentElement,SHEET=document.documentElement.style,META_THEME_COLOR=document.querySelector('meta[name=theme-color]');function setDark(){ROOT.dataset.mode='dark'}function setLight(){ROOT.dataset.mode='light'}localStorage.getItem('isDark')=='true'?setDark():localStorage.getItem('isDark')=='false'&&setLight();function getAccent(){var a;return ROOT.dataset.mode==='dark'?localStorage.getItem('darkAccent')===null?(a="#f27466"):(a=localStorage.getItem('darkAccent')):ROOT.dataset.mode==='light'&&(localStorage.getItem('lightAccent')===null?(a="#225670"):(a=localStorage.getItem('lightAccent'))),a}var activeAccent=getAccent();SHEET.setProperty('--accent',activeAccent),META_THEME_COLOR.setAttribute('content',activeAccent);function updateAccent(){var a=getAccent();SHEET.setProperty('--accent',a),PALETTE.value=a,META_THEME_COLOR.setAttribute('content',a)}document.addEventListener('DOMContentLoaded',function(){PALETTE.value=activeAccent;function a(){document.body.style.transition=document.querySelector('header').style.transition=document.querySelector('footer').style.transition='background-color .3s ease, color .3s ease'}function b(){a(),ROOT.dataset.mode=='light'?(setDark(),localStorage.setItem('isDark','true')):(setLight(),localStorage.setItem('isDark','false')),updateAccent()}document.querySelector('footer button').addEventListener('click',b)})</script></head><body><header><a href=/>rb9</a><nav aria-label="Main menu."><ul><li><a class=btn href=/posts/>Posts</a></li><li><a class=btn href=https://hummus.rb9.nl/>RFC Hummus</a></li><li><a class=btn href=/posts/index.xml>RSS</a></li></ul></nav></header><div class=filler><main><article><header><h1>Running your own services on your SOHO router for the greater good</h1><section class=terms><ul><li><a class=btn href=/tags/hardware/>hardware</a></li><li><a class=btn href=/tags/networking/>networking</a></li></ul></section><p>Published on <time datetime=2021-03-12>2021-03-12</time>. Last updated on <time datetime=2021-03-20>2021-03-20</time></p></header><details class=toc open><summary class=outline-dashed>Contents</summary><nav id=TableOfContents><ul><li><a href=#tldr>TL;DR</a></li><li><a href=#setup>Setup</a><ul><li><a href=#goals>Goals</a></li></ul></li><li><a href=#information-gathering>Information gathering</a><ul><li><a href=#looking-for-hints-on-the-filesystem>Looking for hints on the filesystem</a></li><li><a href=#searching-for-prior-art>Searching for prior art</a></li><li><a href=#finding-an-entrypoint-the-ole-fashioned-way>Finding an entrypoint the ole' fashioned way</a></li></ul></li><li><a href=#persistence>Persistence</a><ul><li><a href=#decoding-and-encoding-backup-files>Decoding and encoding backup files</a></li><li><a href=#partially-reverse-engineering-the-de-compression-algorithm>Partially reverse engineering the (de-)compression algorithm</a></li><li><a href=#emulating-the-compression-algorithm-with-angr-and-unicorn>Emulating the compression algorithm with angr and unicorn</a></li></ul></li><li><a href=#putting-it-all-together>Putting it all together</a></li></ul></nav></details><p>Recently, I&rsquo;ve been wanting to run a <a href=https://pi-hole.net>PiHole</a> server for ad-blocking in my home network, but I didn&rsquo;t want to set up a machine exclusively for it.
So, I thought I could reuse a Raspberry Pi 4 that is running <a href=https://octoprint.org>OctoPrint</a> for a PiHole setup. This worked fine for the most part, but I wasn&rsquo;t fan of the setup for a couple of reasons:</p><ol><li>The RPi4 is hooked up to the network over WiFi. Ideally, the recursive DNS resolver that my entire home network will be using should not have a lot of latency, and I would rather not have it be on a WiFi connected node since most of our personal devices at home are also on WiFi.</li><li>I don&rsquo;t keep the RPi4 running at all times to conserve energy, but I would have to if I&rsquo;m going to run a DNS server on it.</li></ol><p>I could live with the above, but can&rsquo;t one do better? Just run it on the one device that actually has to be always on and is still (hopefully) low power, your WiFi home router!</p><p>In this post, I&rsquo;ll go over how I would generally go about mucking around with SOHO routers and exactly what I did to achieve my goal in this particular instance with the TP-Link Archer C3200.</p><h2 id=tldr><a class=anchor href=#tldr title='Anchor for "TL;DR".'><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a>TL;DR</h2><p>If you have a TP-Link Archer C3200 or a &ldquo;similar enough model&rdquo; and you&rsquo;d like to run your own tools/services on it, <a href=https://github.com/khalednassar/archer-c3200-tools>follow the instructions in this GitHub repository</a>.</p><h2 id=setup><a class=anchor href=#setup title='Anchor for "Setup".'><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a>Setup</h2><p>The WiFi router we have is a <a href=https://www.tp-link.com/us/home-networking/wifi-router/archer-c3200/>TP-Link Archer C3200</a> which we got on sale a couple of years ago. It is not exactly a great starting point if you&rsquo;d like to run any other piece of software the vendor didn&rsquo;t want you to. The vendor simply does not allow you to execute your own code. There is <em>some</em> access to the device over Telnet but that is highly limited and presents configuration options that are available in the web UI anyway. SSH is listening and accepts connections, and you can login, but you cannot actually get a shell session or execute any commands..</p><p>No biggie, one could usually get around these limitations by changing their device&rsquo;s firmware to an open source alternative like <a href=https://openwrt.org/>OpenWRT</a> or <a href=https://dd-wrt.com/>DD-WRT</a>. However, as it is becoming the norm for SOHO routers, none of these projects have any builds available for the TP-Link Archer C3200. That&rsquo;s because well, the vendor locked the device down even further and it would only accept signed and authenticated firmware from the vendor.</p><p>Ah well, none of this is surprising and is actually standard fare for pretty much every cheap - if you consider $100+ cheap - consumer-grade device out there to my knowledge. So, we&rsquo;ll just find a &ldquo;feature&rdquo; that allows us to do what we want anyway.</p><p align=center><img src=https://media.tenor.com/images/82aad35c011c912856810c247183ec0c/tenor.gif alt="hack the planet"></p><h3 id=goals><a class=anchor href=#goals title='Anchor for "Goals".'><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a>Goals</h3><p>Now that we&rsquo;re determined to take this route, we have to specify what we&rsquo;re looking for a little bit better so we don&rsquo;t end up scope creeping or taking things too far. So here&rsquo;s what we, as well as this article, will constrain ourselves to:</p><ul><li>Finding a <em>persistable</em> code/command execution &ldquo;feature&rdquo;. It doesn&rsquo;t have to be <em>remote</em>, but it has to be automatically triggerable on device startup.</li><li>Identifying a suitable persistent storage option for binaries for the device. This could really be anything, and it would vary quite a lot from device to another, what we&rsquo;re looking for here is ideally simple and limited to the device itself without any external dependencies.</li></ul><p>Additionally, to make this project a bit more approachable for myself as I am an amateur hardware hacker at best, an additional goal is to keep it to software unless it is necessary to open up the device.</p><h2 id=information-gathering><a class=anchor href=#information-gathering title='Anchor for "Information gathering".'><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a>Information gathering</h2><p>First order of business is get a copy of the firmware, usually in some binary format, which we can dissect to try and do a plethora of things:</p><ul><li>Get an idea for how the software side is put together, so what kind of software does the device run, and more importantly, can we use it for our purposes?</li><li>Find default keys or passwords for services like SSH and/or telnet (<em>cough</em> backdoors <em>cough</em>)</li><li>Get our grubby hands on some executables that we can reverse engineer for more information or to find vulnerabilities that we could exploit</li></ul><p>The list goes on and on, you get it.</p><p>Luckily, I won&rsquo;t have to open up the device to get the firmware binary since it&rsquo;s available for <a href=https://www.tp-link.com/en/support/download/archer-c3200/#Firmware>download from the vendor&rsquo;s website</a>. We&rsquo;ll grab ourselves a copy of the latest firmware and find the desired binary blob inside the zip file next to the manual that we&rsquo;ll never touch. At this point, the usual procedure I would go through is to run <a href=https://github.com/ReFirmLabs/binwalk><code>binwalk</code></a>, extract bootloaders/filesystems/whatever and pray that there is no annoying, weird obfuscation. As luck would have it again, there&rsquo;s a very obvious squashfs filesystem that binwalk + sasquatch extracted without a hitch.</p><div class=highlight><pre class=chroma aria-label="Box containing code sample." tabindex=0><code class=language-sh data-lang=sh>$ binwalk -e <span class=s2>&#34;Archer_C3200v1_0.9.1_0.1_up_boot(160712)_201
</span><span class=s2>6-07-12_15.24.12.bin&#34;</span>

DECIMAL       HEXADECIMAL     DESCRIPTION
--------------------------------------------------------------------------------
<span class=m>115204</span>        0x1C204         LZMA compressed data, properties: 0x5D, dictionary size: <span class=m>65536</span> bytes, uncompressed size: <span class=m>268788</span> bytes
<span class=m>263168</span>        0x40400         LZMA compressed data, properties: 0x5D, dictionary size: <span class=m>65536</span> bytes, uncompressed size: <span class=m>3658912</span> bytes
<span class=m>1769984</span>       0x1B0200        Squashfs filesystem, little endian, version 4.0, compression:xz, size: <span class=m>11220560</span> bytes, <span class=m>696</span> inodes, blocksize: <span class=m>131072</span> bytes, created: 2016-07-12 07:22:00

$ ls <span class=s2>&#34;_Archer_C3200v1_0.9.1_0.1_up_boot(160712)_2016-07-12_15.24.12.bin.extracted/squashfs-root&#34;</span>
bin  dev  etc  lib  linuxrc  mnt  proc  sbin  sys  tmp  usr  var  web
</code></pre></div><p>It won&rsquo;t always be this smooth, as the firmware may be obfuscated in a variety of ways. That being said, there is always some way to get around it no matter how obfuscated the firmware is. In the worst case scenario, reversing the bootloader should reveal its dirty secrets, but in my experience I never had to go that far. A combination of basic analysis and some hypotheses gets the job done <a href=http://www.devttys0.com/2011/05/reverse-engineering-firmware-linksys-wag120n/>as explained in this /dev/ttyS0 writeup</a>.</p><h3 id=looking-for-hints-on-the-filesystem><a class=anchor href=#looking-for-hints-on-the-filesystem title='Anchor for "Looking for hints on the filesystem".'><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a>Looking for hints on the filesystem</h3><p>Moving on, we can now have a bit of a look around in the file system, realize it&rsquo;s a Linux-based device (as they often are), find a couple exectuables and run <code>file</code> on them:</p><div class=highlight><pre class=chroma aria-label="Box containing code sample." tabindex=0><code class=language-sh data-lang=sh>$ file bin/busybox
bin/busybox: ELF 32-bit LSB executable, ARM, EABI5 version <span class=m>1</span> <span class=o>(</span>SYSV<span class=o>)</span>, dynamically linked, interpreter /lib/ld-uClibc.so.0, stripped
</code></pre></div><p>Lovely, so now we know that it&rsquo;s a 32-bit ARM device. It&rsquo;s also useful to see if there are any kernel modules around:</p><div class=highlight><pre class=chroma aria-label="Box containing code sample." tabindex=0><code class=language-sh data-lang=sh>$ find . -name <span class=s1>&#39;*.ko&#39;</span> -type f
./lib/modules/GPL_NetUSB.ko
./lib/modules/ipt_STAT.ko
./lib/modules/kmdir/kernel/crypto/arc4.ko
./lib/modules/kmdir/kernel/crypto/ecb.ko
./lib/modules/kmdir/kernel/drivers/net/ctf/ctf.ko
...
</code></pre></div><p>They are one way to easily get some information about the exact kernel version this device runs using <code>modinfo</code>:</p><div class=highlight><pre class=chroma aria-label="Box containing code sample." tabindex=0><code class=language-sh data-lang=sh>$ modinfo ./lib/modules/GPL_NetUSB.ko
filename:       /tmp/_Archer_C3200v1_0.9.1_0.1_up_boot<span class=o>(</span>160712<span class=o>)</span>_2016-07-12_15.24.12.bin.extracted/squashfs-root/./lib/modules/GPL_NetUSB.ko
author:         KCodes
description:    NetUSB module <span class=k>for</span> Linux 2.6 from KCodes.
license:        Dual BSD/GPL
depends:
vermagic:       2.6.36.4brcmarm SMP preempt mod_unload ARMv7
</code></pre></div><p>Fantastic, now we know it&rsquo;s running a 2.6.36.4 kernel and an ARMv7 processor. At this point I&rsquo;ll look around some more in the FS to get an understanding of what&rsquo;s there and what sort of services to expect, taking notes of them to use later. There is no particular methodology that I follow, but I like to figure out at least the following items:</p><ul><li>As shown above: architecture and kernel version that the device is running</li><li>Default configuration files if available and what they generally relate to</li><li>What kind of services are running and how do they map to executables and configuration?</li><li><code>iptables</code> configuration, so what services are normally accessible and from which networks/interfaces?</li><li>For services: are they actually compiled versions of open source tools, and if so what are their versions?</li><li>What accessible services are custom made by the firmware developers or device vendor?</li></ul><h3 id=searching-for-prior-art><a class=anchor href=#searching-for-prior-art title='Anchor for "Searching for prior art".'><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a>Searching for prior art</h3><p>Armed with a bit more in depth information about the device, I would usually try to find online resources about the device or &ldquo;related devices&rdquo;. One could also search for &ldquo;related features&rdquo; like the specific way a certain model has its web UI URLs set up, that could indicate that two different models are using very similar web configuration backends.</p><p>In the case of the Archer C3200, there&rsquo;s quite a few similar models, with very similar names all starting with Archer: Archer C7, C5 and C2300. For some of these models, there are actually rather relevant resources that would prove very useful:</p><ol><li>Wiki and tools for hacking the Archer C2300: <a href=https://github.com/acc-/tplink-archer-c2300>https://github.com/acc-/tplink-archer-c2300</a></li><li>Remote code exec for the Archer C5: <a href=https://github.com/JackDoan/TP-Link-ArcherC5-RCE>https://github.com/JackDoan/TP-Link-ArcherC5-RCE</a></li><li>Another RCE for the Archer C7: <a href=https://www.checkpoint.com/defense/advisories/public/2020/cpai-2020-0338.html/>https://www.checkpoint.com/defense/advisories/public/2020/cpai-2020-0338.html/</a></li><li>A bog-standard command injection in the Archer C2 &ldquo;Diagnostic&rdquo; page using the &ldquo;ping&rdquo; util: <a href=https://pierrekim.github.io/blog/2017-02-09-tplink-c2-and-c20i-vulnerable.html>https://pierrekim.github.io/blog/2017-02-09-tplink-c2-and-c20i-vulnerable.html</a></li></ol><p>Reviewing the above, it looks like a huge chunk of our work may already be cut out for us and if not, it looks like there&rsquo;s quite a bit of potential for exploitation.</p><p>As a matter of fact, the same <a href=https://pierrekim.github.io/blog/2017-02-09-tplink-c2-and-c20i-vulnerable.html>command injection vulnerability in the Archer C2 &ldquo;Diagnostic&rdquo; page</a> works on the Archer C3200 firmware version 0.9.1 0.1 v004b.0 Build 160712, which is the latest available version as of the time of writing of this post.</p><h3 id=finding-an-entrypoint-the-ole-fashioned-way><a class=anchor href=#finding-an-entrypoint-the-ole-fashioned-way title='Anchor for "Finding an entrypoint the ole' fashioned way".'><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a>Finding an entrypoint the ole' fashioned way</h3><p>It is really nice that an already published vulnerability is still exploitable in another model, but in my limited experience with router exploration, there is quite often a straightforward command injection for some inexplicable reason. In one way or another, the web UI or some other subsystem would have some form of command injection vulnerability, and here are some of the places that are worth taking a look at:</p><ul><li>Like the above, some form of diagnostics page which runs a standard command line tool like <code>ping</code> or <code>traceroute</code>.</li><li>NTP client configuration: most firmware developers don&rsquo;t want to write their own NTP client for good reasons, but it&rsquo;s mind-boggling how often NTP clients get daemonized by some vendor-made orchestrator service on the device, and how often these clients are just started with <code>sprintf</code>&rsquo;d together configuration and invoked within a shell with <code>system</code>.</li><li>Logging facilities: for whatever reason, some routers' firmware invoke <a href=https://man7.org/linux/man-pages/man1/logger.1.html><code>logger</code></a> within a shell context, and sometimes this is done in an unsanitary way. What do you usually see being logged in the web UI? DHCP leases! What do these sometimes contain? <a href=https://www.iana.org/assignments/bootp-dhcp-parameters/bootp-dhcp-parameters.xhtml>DHCP option 12 - hostname</a>.</li></ul><p>And if all else fails, reverse engineering parts of the firmware and bug hunting in the binaries is always an option.</p><h2 id=persistence><a class=anchor href=#persistence title='Anchor for "Persistence".'><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a>Persistence</h2><p>We&rsquo;re quite far already without doing much work, we can already get a shell and run commands over telnet in a similar method to the one described <a href=https://pierrekim.github.io/blog/2017-02-09-tplink-c2-and-c20i-vulnerable.html>in this advisory</a>. We can even compile and drop other executables if we desire, but this gives us code execution only, not persistence.</p><p>&ldquo;What about the filesystem?&rdquo; you ask. Indeed, if it were something other than a read-only SquashFS filesystem, that could have worked just fine. However, there are no other filesystems. We could try to figure out how to change the firmware for one of our own choosing, perhaps by finding an issue in the firmware signature checking routine, but it seems a little too far given the current scope and if it were that straightforward I&rsquo;d expect someone else to have figured it out by then.</p><p>Hmm.. this conundrum leads to an obvious question though: how does the device store configuration changes, and can we piggyback onto them?</p><p>After a bit of reverse engineering, the answer to &ldquo;how does the device store configuration changes&rdquo; is: it does so by utilizing some flash block device, which I didn&rsquo;t want to muck around with, unless necessary, so I didn&rsquo;t investigate much further. What we can do instead is use some hints from the <a href=https://github.com/acc-/tplink-archer-c2300>Archer C2300 hacking wiki</a>.</p><p>It&rsquo;s not that the systems are similar enough for the <a href=https://github.com/acc-/tplink-archer-c2300/wiki/Saving-files-permanently>same persistence method</a> to work; it&rsquo;s that the <a href=https://github.com/acc-/tplink-archer-c2300/tree/master/scripts>provided scripts</a> are mainly aimed at modifying the configuration files, which is mentioned in <a href=https://github.com/JackDoan/TP-Link-ArcherC5-RCE>other advisories too</a>.</p><h3 id=decoding-and-encoding-backup-files><a class=anchor href=#decoding-and-encoding-backup-files title='Anchor for "Decoding and encoding backup files".'><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a>Decoding and encoding backup files</h3><p>I needed to take a look at the configuration files, and it makes sense: they may contain a few configuration options that are used within shell command invocations without sanitization on startup. After all, it should be already sanitized by whatever system was used to change them, right?</p><p><img loading=lazy src=/assets/blog/img/1c9dc4de9a9a523491790bef07773c1ac6ad9b911e19d6f762bff2eacfc2a8e5.png alt="assets/Pasted image 20210312063835.png">
<em>Turns out that threat models matter a bit more in this context. Source: <a href=https://xkcd.com/327/>xkcd</a>.</em></p><p>So how do we do so? The files are in some binary format, but the <a href=https://github.com/acc-/tplink-archer-c2300>Archer C2300 hacking wiki</a> has some tools for converting the backup .bin files to XML and back. Awesome!</p><p>However, they do not work with the Archer C3200 because the format for these files has changed. <em>Surprise!</em></p><p>After spending some time looking around and having tried all the other decryption/decoding tools I could find to no avail, I decided that it was time to start doing some reverse engineering.</p><h3 id=partially-reverse-engineering-the-de-compression-algorithm><a class=anchor href=#partially-reverse-engineering-the-de-compression-algorithm title='Anchor for "Partially reverse engineering the (de-)compression algorithm".'><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a>Partially reverse engineering the (de-)compression algorithm</h3><p>I initially went about going through the webserver binaries in <a href=https://ghidra-sre.org/>Ghidra</a> until I hit <code>libcmm.so</code> and <code>libcutil.so</code>, which are a couple of shared libraries that implement a decent chunk of functionality used by a few subsystems.</p><p><code>libcmm.so</code> contains a couple of interesting functions: <code>rsl_sys_backupCfg</code> and <code>rsl_sys_restoreCfg</code> for dealing with backup and restore, respectively. After going through them briefly, it seems that the encoding process hasn&rsquo;t changed too much compared to a few other models. The hardcoded DES encryption key used is different, but shows up for other models as well, and the structure is more or less the same for the backup operation:</p><ol><li>Build the backup XML file</li><li>Compress the XML file using proprietary compression algorithm</li><li>Encrypt the compressed file with DES under the static hardcoded key</li><li>Compute the MD5 hash of the encrypted file</li><li>Output the bin file as the MD5 hash of the encrypted file, followed by the encrypted file itself</li></ol><p>Looking at the suboperations, it kind of doesn&rsquo;t make sense that the tools identified so far don&rsquo;t work after changing the hardcoded DES key to match that of the C3200. In fact, out of the main significant suboperations, only the compression algorithm seems to be the likely candidate for change since everything else is supposedly standard. It&rsquo;s implemented in <code>libcutil.so</code> as <code>cen_compressBuff</code> and <code>cen_uncompressBuff</code>, so we&rsquo;ll go ahead and reverse engineer them.</p><p>Or.. maybe not. I don&rsquo;t know about you, but I don&rsquo;t like doing more work than necessary when it isn&rsquo;t inherently interesting, so I took a break from trying to reverse engineer them and looked up the function names in hopes of finding some more information.</p><p>And for <code>cen_uncompressBuff</code>, I hit a couple of jackpots:</p><ol><li><a href=https://github.com/sta-c0000/tpconf_bin_xml>Tools and information for mucking about with the TP-Link TD-W9970 and TD-W9980 routers, including a method for command execution on startup through configuration files!</a></li><li><a href=https://pwn2learn.dusuel.fr/blog/unauthenticated-root-shell-on-tp-link-tl-wr902ac-router/>A rather concerning but fantastic write up about a full-blown unauthenticated root shell vulnerability chain on the TP-Link TL-WR902AC</a></li></ol><p>Aand we basically have everything we need! After comparing the <code>cen_uncompressBuff</code> function in Ghidra with the implementation in the <a href=https://github.com/sta-c0000/tpconf_bin_xml>tpconf_bin_xml</a> repository, it was easy to identify the small change in the algorithm. However, the corresponding <code>cen_compressBuff</code> changes did not work.</p><h3 id=emulating-the-compression-algorithm-with-angr-and-unicorn><a class=anchor href=#emulating-the-compression-algorithm-with-angr-and-unicorn title='Anchor for "Emulating the compression algorithm with angr and unicorn".'><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a>Emulating the compression algorithm with angr and unicorn</h3><p>Rather than spend some more time trying to hunt down exactly what&rsquo;s wrong, I modified the code for emulating <code>cen_uncompressBuff</code> provided in the <a href=https://pwn2learn.dusuel.fr/blog/unauthenticated-root-shell-on-tp-link-tl-wr902ac-router/>pwn2learn writeup</a> and used <a href=https://angr.io/>angr</a> with <a href=https://www.unicorn-engine.org/>unicorn</a> to emulate <code>cen_compressBuff</code> instead.
It took about 30 minutes from looking at the pwn2learn angr code next to the decompiled <code>cen_compressBuff</code>, to having a working compression routine.</p><p>Emulation is definitely a much faster approach than reverse engineering especially when testing things out, but it doesn&rsquo;t always work out. In this particular case, the function was a great candidate for emulation because it has to be generally independent of the device&rsquo;s state and it invoked a handful of functions, which in turn were also simple.</p><p>The resulting code, along with usage instructions, can be found <a href=https://github.com/khalednassar/archer-c3200-tools>here</a>.</p><h2 id=putting-it-all-together><a class=anchor href=#putting-it-all-together title='Anchor for "Putting it all together".'><svg aria-hidden="true"><use xlink:href="#hashtag"/></svg></a>Putting it all together</h2><p>Well well, we have a way to execute commands on startup and we can use a usb drive to store our binaries/services/scripts, which is also mounted automatically on startup.
We also have all the tools needed to craft configuration file with the startup commands that the device will happily restore for us.</p><p>We only have to provide our binaries for the tools that we&rsquo;d like to use! That, IMHO, comes in varying degrees of &ldquo;complexity&rdquo;. It can be as easy as installing the right <code>gcc</code> toolchain from your favorite distro&rsquo;s package repositories and following a simple writeup. In other cases, it can involve building a cross-compilation toolchain, especially when dealing with slightly more exotic architectures (for whatever reason, <code>armeb</code>/ARM Big Endian is one of them). The process of getting the right toolchain built can be made a lot easier by using <a href=https://buildroot.org/>buildroot</a>, but is still a bit of a chore. Usually, I find myself sticking to compiling statically against <a href=https://www.musl-libc.org/>musl libc</a>, since it supports ridiculously old kernels which these devices often come with. Case in point: the Archer C3200 comes with a 2.6.36.4 kernel which was already 6 years old when the device came on the market!</p><p>For this particular foray, I wanted to run a blackhole DNS server on the router as an alternative to PiHole. As luck would have it once more, a friend was already working on <a href=https://github.com/tjclement/nukedns>a simple one in rust</a>! It turns out that statically cross compiling to ARMv7 LE with rust is rather straightforward:</p><ol><li>Install a usable toolchain, on Ubuntu/Debian that would be <code>gcc-arm-linux-gnueabi</code></li><li>Install <a href=https://rustup.rs/>rustup</a> and add the <code>armv7-unknown-linux-musleabi</code> target</li><li>Prepare a cargo config file pointing the linker of the target to the toolchain&rsquo;s gcc</li></ol><p>The last couple of steps above can be done with these bash commands in the root directory of a project that uses <code>cargo</code>:</p><div class=highlight><pre class=chroma aria-label="Box containing code sample." tabindex=0><code class=language-bash data-lang=bash>rustup target add armv7-unknown-linux-musleabi
mkdir .cargo
cat <span class=s>&lt;&lt; EOF &gt;&gt; .cargo/config
</span><span class=s>[target.armv7-unknown-linux-musleabi]
</span><span class=s>linker = &#34;arm-linux-gnueabi-gcc&#34;
</span><span class=s>EOF</span>
</code></pre></div><p>Then let&rsquo;s get ourselves a stripped release build (the <code>RUSTFLAGS</code> env variable is to pass the strip binary flag to the linker)</p><div class=highlight><pre class=chroma aria-label="Box containing code sample." tabindex=0><code class=language-sh data-lang=sh><span class=nv>RUSTFLAGS</span><span class=o>=</span><span class=s1>&#39;-C link-arg=-s&#39;</span> cargo build --release --target<span class=o>=</span>armv7-unknown-linux-musleabi
</code></pre></div><p>And we end up with a statically compiled binary version of nukedns at <code>target/armv7-unknown-linux-musleabi/release/nukedns</code></p><p>I then prepared a startup script which would launch <code>nukedns</code>, put them along with the <code>denylist.txt</code> on a USB drive and plugged it into the router. After a router reboot and some configuration changes for the DNS servers on the router web interface, I was in the business of <code>NXDOMAIN</code>ing known advertising domain names on my home network, all without having to run an extra device, and maybe you can too!</p></article></main></div><footer><section class=req-js><button class=outline-dashed title="Change to light/dark mode."><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><use xlink:href="#adjust"/></svg></button><input class=outline-dashed type=color list=presets value=#f27466 title="Change accent color." aria-label="Change accent color."><datalist id=presets><option value=#225670><option value=#f27466><option value=#1f676b><option value=#f3a530><option value=#902b37><option value=#1dbc91><option value=#754e85><option value=#7fc121><option value=#a8314a><option value=#ff7433><option value=#3e6728><option value=#c063bd></datalist></section><p>Rendered by <a href=https://gohugo.io>Hugo</a><br>Theme is <a href=https://gitlab.com/rmaguiar/hugo-theme-color-your-world>Color Your World</a> by <a href=https://gitlab.com/rmaguiar>Raphael Aguiar<a></p></footer><svg xmlns="http://www.w3.org/2000/svg" width="0" height="0" aria-hidden="true"><symbol viewBox="0 0 512 512" id="adjust"><path d="M8 256c0 136.966 111.033 248 248 248s248-111.034 248-248S392.966 8 256 8 8 119.033 8 256zm248 184V72c101.705.0 184 82.311 184 184 0 101.705-82.311 184-184 184z"/></symbol><symbol viewBox="0 0 448 512" id="hashtag"><path d="M440.667 182.109l7.143-40c1.313-7.355-4.342-14.109-11.813-14.109h-74.81l14.623-81.891C377.123 38.754 371.468 32 363.997 32h-40.632a12 12 0 00-11.813 9.891L296.175 128H197.54l14.623-81.891C213.477 38.754 207.822 32 200.35 32h-40.632a12 12 0 00-11.813 9.891L132.528 128H53.432a12 12 0 00-11.813 9.891l-7.143 40C33.163 185.246 38.818 192 46.289 192h74.81L98.242 320H19.146a12 12 0 00-11.813 9.891l-7.143 40C-1.123 377.246 4.532 384 12.003 384h74.81L72.19 465.891C70.877 473.246 76.532 480 84.003 480h40.632a12 12 0 0011.813-9.891L151.826 384h98.634l-14.623 81.891C234.523 473.246 240.178 480 247.65 480h40.632a12 12 0 0011.813-9.891L315.472 384h79.096a12 12 0 0011.813-9.891l7.143-40c1.313-7.355-4.342-14.109-11.813-14.109h-74.81l22.857-128h79.096a12 12 0 0011.813-9.891zM261.889 320h-98.634l22.857-128h98.634l-22.857 128z"/></symbol><symbol viewBox="0 0 320 512" id="caret-down"><path d="M31.3 192h257.3c17.8.0 26.7 21.5 14.1 34.1L174.1 354.8c-7.8 7.8-20.5 7.8-28.3.0L17.2 226.1C4.6 213.5 13.5 192 31.3 192z"/></symbol></svg><script>'use strict';const PALETTE=document.querySelector('footer input');PALETTE.onchange=function(){const a=PALETTE.value;SHEET.setProperty('--accent',a),ROOT.dataset.mode==='light'?localStorage.setItem('lightAccent',a):localStorage.setItem('darkAccent',a),updateAccent()}</script></body></html>